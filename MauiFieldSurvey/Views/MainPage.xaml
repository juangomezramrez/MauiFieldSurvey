<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:MauiFieldSurvey.ViewModels"
             xmlns:models="clr-namespace:MauiFieldSurvey.Models"
             xmlns:converters="clr-namespace:MauiFieldSurvey.Converters"
             x:Class="MauiFieldSurvey.Views.MainPage"
             Title="Levantamiento en Campo linux 4 ">

  <ContentPage.Resources>
    <ResourceDictionary>
      <converters:JobImageConverter x:Key="JobImageConverter"/>
    </ResourceDictionary>
  </ContentPage.Resources>

  <Grid RowDefinitions="Auto, Auto, *">

    <VerticalStackLayout Grid.Row="0" Padding="15" Spacing="10" BackgroundColor="#f8f9fa">
      <Label Text="{Binding StatusMessage}" 
                   TextColor="#d32f2f"
                   FontSize="14"
                   FontAttributes="Bold"
                   HorizontalOptions="Center"/>

      <Button Text="📷 CAPTURAR FOTO"
                    Command="{Binding TakePhotoCommand}"
                    IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                    HeightRequest="50"
                    CornerRadius="25"
                    FontSize="16"
                    FontAttributes="Bold"
                    BackgroundColor="#1976D2"
                    TextColor="White"/>

      <ActivityIndicator IsRunning="{Binding IsBusy}" 
                               IsVisible="{Binding IsBusy}"
                               Color="#1976D2"/>
    </VerticalStackLayout>

    <BoxView Grid.Row="1" HeightRequest="1" Color="#E0E0E0"/>

    <CollectionView Grid.Row="2" 
                        ItemsSource="{Binding Jobs}"
                        SelectionMode="None"
                        Margin="10">
      <CollectionView.EmptyView>
        <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center">
          <Label Text="📭" FontSize="50" HorizontalOptions="Center"/>
          <Label Text="No hay fotos capturadas." TextColor="Gray"/>
        </VerticalStackLayout>
      </CollectionView.EmptyView>

      <CollectionView.ItemsLayout>
        <LinearItemsLayout Orientation="Vertical" ItemSpacing="10"/>
      </CollectionView.ItemsLayout>

      <CollectionView.ItemTemplate>
        <DataTemplate x:DataType="models:PhotoJob">
          <Frame Padding="0" CornerRadius="10" HasShadow="True" BorderColor="#E0E0E0">
            <Grid ColumnDefinitions="100, *" HeightRequest="100">

              <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=JobTappedCommand}"
                                                      CommandParameter="{Binding .}"/>
              </Grid.GestureRecognizers>

              <Image Grid.Column="0" 
                                   Source="{Binding ., Converter={StaticResource JobImageConverter}}"
                                   Aspect="AspectFill"
                                   BackgroundColor="LightGray"/>

              <VerticalStackLayout Grid.Column="1" Padding="10" Spacing="2" VerticalOptions="Center">
                <Label Text="{Binding Timestamp, StringFormat='📅 {0:HH:mm:ss}'}" 
                                       FontAttributes="Bold" TextColor="#333"/>

                <HorizontalStackLayout Spacing="5">
                  <Label Text="📍" FontSize="12"/>
                  <Label Text="{Binding Latitude, StringFormat='{0:F4}'}" FontSize="12" TextColor="Gray"/>
                  <Label Text="{Binding Longitude, StringFormat='{0:F4}'}" FontSize="12" TextColor="Gray"/>
                </HorizontalStackLayout>

                <Label Text="{Binding Status}" FontSize="12" FontAttributes="Bold">
                  <Label.Triggers>
                    <DataTrigger TargetType="Label" Binding="{Binding Status}" Value="Completed">
                      <Setter Property="TextColor" Value="Green"/>
                    </DataTrigger>
                    <DataTrigger TargetType="Label" Binding="{Binding Status}" Value="Pending">
                      <Setter Property="TextColor" Value="Orange"/>
                    </DataTrigger>
                    <DataTrigger TargetType="Label" Binding="{Binding Status}" Value="Failed">
                      <Setter Property="TextColor" Value="Red"/>
                    </DataTrigger>
                  </Label.Triggers>
                </Label>
              </VerticalStackLayout>

              <Label Grid.Column="1" Text="›" FontSize="24" TextColor="Gray" 
                                   HorizontalOptions="End" VerticalOptions="Center" Margin="0,0,10,0"/>
            </Grid>
          </Frame>
        </DataTemplate>
      </CollectionView.ItemTemplate>
    </CollectionView>
  </Grid>
</ContentPage>